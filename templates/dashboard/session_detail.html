{% extends "base.html" %}

{% block title %}Session - {{ service.name }} - shymini{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="/service/{{ service.id }}" class="text-indigo-600 hover:underline text-sm">‚Üê Back to {{ service.name }}</a>
    <h1 class="text-2xl font-bold text-gray-900 mt-2">Session Details</h1>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Session Info -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Session Info</h2>
        <dl class="space-y-4">
            <div>
                <dt class="text-xs text-gray-500 uppercase">Session ID</dt>
                <dd class="text-sm font-mono text-gray-900">{{ session.id }}</dd>
            </div>
            {% if !session.identifier.is_empty() %}
            <div>
                <dt class="text-xs text-gray-500 uppercase">Identifier</dt>
                <dd class="text-sm text-gray-900">{{ session.identifier }}</dd>
            </div>
            {% endif %}
            <div>
                <dt class="text-xs text-gray-500 uppercase">Started</dt>
                <dd class="text-sm text-gray-900">{{ session.start_time }}</dd>
            </div>
            <div>
                <dt class="text-xs text-gray-500 uppercase">Last Seen</dt>
                <dd class="text-sm text-gray-900">{{ session.last_seen }}</dd>
            </div>
            <div>
                <dt class="text-xs text-gray-500 uppercase">Bounce</dt>
                <dd class="text-sm text-gray-900">{% if session.is_bounce %}Yes{% else %}No{% endif %}</dd>
            </div>
        </dl>
    </div>

    <!-- Device Info -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Device</h2>
        <dl class="space-y-4">
            <div>
                <dt class="text-xs text-gray-500 uppercase">Browser</dt>
                <dd class="text-sm text-gray-900">{% if session.browser.is_empty() %}Unknown{% else %}{{ session.browser }}{% endif %}</dd>
            </div>
            <div>
                <dt class="text-xs text-gray-500 uppercase">Operating System</dt>
                <dd class="text-sm text-gray-900">{% if session.os.is_empty() %}Unknown{% else %}{{ session.os }}{% endif %}</dd>
            </div>
            <div>
                <dt class="text-xs text-gray-500 uppercase">Device Type</dt>
                <dd class="text-sm text-gray-900">{{ session.device_type }}</dd>
            </div>
            {% if !session.device.is_empty() %}
            <div>
                <dt class="text-xs text-gray-500 uppercase">Device</dt>
                <dd class="text-sm text-gray-900">{{ session.device }}</dd>
            </div>
            {% endif %}
        </dl>
    </div>

    <!-- Location Info -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Location</h2>
        <dl class="space-y-4">
            <div>
                <dt class="text-xs text-gray-500 uppercase">Country</dt>
                <dd class="text-sm text-gray-900">{% if session.country.is_empty() %}Unknown{% else %}{{ session.country }}{% endif %}</dd>
            </div>
            {% if !session.asn.is_empty() %}
            <div>
                <dt class="text-xs text-gray-500 uppercase">ASN</dt>
                <dd class="text-sm text-gray-900">{{ session.asn }}</dd>
            </div>
            {% endif %}
            {% if !session.time_zone.is_empty() %}
            <div>
                <dt class="text-xs text-gray-500 uppercase">Time Zone</dt>
                <dd class="text-sm text-gray-900">{{ session.time_zone }}</dd>
            </div>
            {% endif %}
            {% match session.ip %}
            {% when Some with (ip) %}
            <div>
                <dt class="text-xs text-gray-500 uppercase">IP Address</dt>
                <dd class="text-sm font-mono text-gray-900">{{ ip }}</dd>
            </div>
            {% when None %}
            {% endmatch %}
        </dl>
    </div>
</div>

<!-- Hits -->
<div class="mt-6 bg-white rounded-lg shadow">
    <div class="p-4 border-b">
        <h2 class="text-lg font-semibold text-gray-900">Page Views ({{ hits.len() }})</h2>
    </div>
    <div class="p-4">
        {% if hits.is_empty() %}
        <p class="text-gray-500 text-center py-4">No page views recorded</p>
        {% else %}
        <table class="w-full">
            <thead class="text-xs text-gray-500 uppercase border-b">
                <tr>
                    <th class="text-left py-2">Started</th>
                    <th class="text-left py-2">Last Seen</th>
                    <th class="text-left py-2">Page</th>
                    <th class="text-left py-2">Referrer</th>
                    <th class="text-left py-2">Tracker</th>
                    <th class="text-right py-2">Load Time</th>
                    <th class="text-right py-2">Heartbeats</th>
                </tr>
            </thead>
            <tbody class="text-sm">
                {% for hit in hits %}
                <tr class="border-t">
                    <td class="py-2 text-gray-600 whitespace-nowrap">{{ hit.start_time }}</td>
                    <td class="py-2 text-gray-600 whitespace-nowrap">{{ hit.last_seen }}</td>
                    <td class="py-2 truncate max-w-xs">
                        {% if hit.location.is_empty() %}Unknown{% else %}{{ hit.location }}{% endif %}
                        {% if hit.initial %}
                        <span class="ml-1 text-xs bg-blue-100 text-blue-800 px-1 rounded">Initial</span>
                        {% endif %}
                    </td>
                    <td class="py-2 text-gray-600 truncate max-w-xs">
                        {% if hit.referrer.is_empty() %}Direct{% else %}{{ hit.referrer }}{% endif %}
                    </td>
                    <td class="py-2 text-gray-600">{{ hit.tracker }}</td>
                    <td class="py-2 text-gray-600 text-right">
                        {% match hit.load_time %}
                        {% when Some with (lt) %}{{ lt }}ms{% when None %}-{% endmatch %}
                    </td>
                    <td class="py-2 text-gray-600 text-right">{{ hit.heartbeats }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

{% if !session.user_agent.is_empty() %}
<!-- User Agent -->
<div class="mt-6 bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-2">User Agent</h2>
    <p class="text-sm font-mono text-gray-600 break-all">{{ session.user_agent }}</p>
</div>
{% endif %}
{% endblock %}
