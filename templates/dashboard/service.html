{% extends "base.html" %}

{% block title %}{{ service.name }} - shymini{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
    <div class="min-w-0">
        <h1 class="text-2xl font-bold text-gray-900 truncate">{{ service.name }}</h1>
        {% if !service.link.is_empty() %}
        <a href="{{ service.link }}" target="_blank" class="text-indigo-600 hover:underline text-sm block truncate">{{ service.link }}</a>
        {% endif %}
    </div>
    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 flex-shrink-0">
        <div class="flex flex-wrap items-center gap-2">
            <input type="text" id="urlPattern" name="urlPattern" value="{{ url_pattern }}"
                   placeholder="URL regex filter"
                   class="border rounded px-3 py-2 text-sm w-32 sm:w-40"
                   hx-get="/service/{{ service.id }}/stats"
                   hx-target="#stats-container"
                   hx-trigger="change, keyup delay:500ms"
                   hx-include="#startDate, #endDate">
            <input type="datetime-local" id="startDate" name="startDate" value="{{ start_date }}"
                   class="border rounded px-3 py-2 text-sm"
                   hx-get="/service/{{ service.id }}/stats"
                   hx-target="#stats-container"
                   hx-include="#endDate, #urlPattern"
                   onchange="validateDateRange()">
            <span class="text-gray-500">to</span>
            <input type="datetime-local" id="endDate" name="endDate" value="{{ end_date }}"
                   class="border rounded px-3 py-2 text-sm"
                   hx-get="/service/{{ service.id }}/stats"
                   hx-target="#stats-container"
                   hx-include="#startDate, #urlPattern"
                   onchange="validateDateRange()">
            <span id="dateError" class="text-red-500 text-xs hidden">Start must be before end</span>
        </div>
        <a href="/service/{{ service.id }}/manage" class="border border-gray-300 bg-white text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 hover:border-gray-400 shadow-sm whitespace-nowrap">
            Manage
        </a>
    </div>
</div>

{% if !stats.has_hits %}
<div class="bg-white rounded-lg shadow p-8">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Get Started</h2>
    <p class="text-gray-600 mb-4">Add this script to your website to start tracking:</p>
    <div class="bg-gray-100 rounded p-4 font-mono text-sm overflow-x-auto">
        <pre>&lt;script defer src="http://localhost:8080/trace/app_{{ service.tracking_id }}.js"&gt;&lt;/script&gt;</pre>
    </div>
    <p class="text-gray-500 text-sm mt-4">
        Or use the pixel tracker for no-JS tracking:
    </p>
    <div class="bg-gray-100 rounded p-4 font-mono text-sm overflow-x-auto mt-2">
        <pre>&lt;img src="http://localhost:8080/trace/px_{{ service.tracking_id }}.gif" style="display:none"&gt;</pre>
    </div>
</div>
{% else %}
<div id="stats-container" hx-on:htmx:after-swap="renderChart()">
{% include "components/stats_content.html" %}
</div>

<!-- Recent Sessions -->
<div class="bg-white rounded-lg shadow">
    <div class="p-4 border-b flex justify-between items-center">
        <h3 class="font-semibold text-gray-900">Recent Sessions</h3>
        <a href="/service/{{ service.id }}/sessions" class="text-indigo-600 hover:underline text-sm">
            View all &rarr;
        </a>
    </div>
    <div class="p-4">
        {% if sessions.is_empty() %}
        <p class="text-gray-500 text-center py-4">No sessions found</p>
        {% else %}
        <table class="w-full">
            <thead class="text-xs text-gray-500 uppercase border-b">
                <tr>
                    <th class="text-left py-2">Session</th>
                    <th class="text-left py-2">Started</th>
                    <th class="text-left py-2">Browser</th>
                    <th class="text-left py-2">OS</th>
                    <th class="text-left py-2">Country</th>
                    <th class="text-left py-2">Device</th>
                </tr>
            </thead>
            <tbody class="text-sm">
                {% for session in sessions %}
                <tr class="border-t hover:bg-gray-50">
                    <td class="py-2">
                        <a href="/service/{{ service.id }}/sessions/{{ session.id }}" class="text-indigo-600 hover:underline">
                            {% if session.identifier.is_empty() %}{{ session.id }}{% else %}{{ session.identifier }}{% endif %}
                        </a>
                    </td>
                    <td class="py-2 text-gray-600"><time datetime="{{ session.start_time.to_rfc3339() }}">{{ session.start_time.format("%b %d, %H:%M") }}</time></td>
                    <td class="py-2 text-gray-600">{% if session.browser.is_empty() %}Unknown{% else %}{{ session.browser }}{% endif %}</td>
                    <td class="py-2 text-gray-600">{% if session.os.is_empty() %}Unknown{% else %}{{ session.os }}{% endif %}</td>
                    <td class="py-2 text-gray-600">{% if session.country.is_empty() %}Unknown{% else %}{{ session.country }}{% endif %}</td>
                    <td class="py-2 text-gray-600">{{ session.device_type }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_body %}
<script>
// Chart rendering - reads data from #chart element's data attributes
function renderChart() {
    var chartEl = document.getElementById('chart');
    if (!chartEl) return;

    // Destroy existing chart
    if (window.shyminiChart) {
        window.shyminiChart.destroy();
        window.shyminiChart = null;
    }

    var labels = JSON.parse(chartEl.dataset.labels || '[]');
    var sessions = JSON.parse(chartEl.dataset.sessions || '[]');
    var hits = JSON.parse(chartEl.dataset.hits || '[]');

    if (!labels.length) return;

    var options = {
        series: [
            { name: 'Sessions', data: sessions },
            { name: 'Hits', data: hits }
        ],
        chart: {
            type: 'area',
            height: 300,
            toolbar: { show: false },
            zoom: { enabled: false }
        },
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 2 },
        fill: {
            type: 'gradient',
            gradient: { opacityFrom: 0.4, opacityTo: 0.1 }
        },
        tooltip: {
            x: {
                formatter: function(value, { dataPointIndex }) {
                    return labels[dataPointIndex];
                }
            }
        },
        xaxis: {
            categories: labels,
            labels: { rotate: -45, rotateAlways: true }
        },
        yaxis: { min: 0 },
        colors: ['#6366f1', '#10b981'],
        legend: { position: 'top' }
    };

    window.shyminiChart = new ApexCharts(chartEl, options);
    window.shyminiChart.render();
}

function syncDatesToUrl() {
    var startInput = document.getElementById('startDate');
    var endInput = document.getElementById('endDate');
    var urlPatternInput = document.getElementById('urlPattern');
    var params = new URLSearchParams(window.location.search);

    if (startInput && startInput.value) {
        params.set('startDate', startInput.value);
    } else {
        params.delete('startDate');
    }
    if (endInput && endInput.value) {
        params.set('endDate', endInput.value);
    } else {
        params.delete('endDate');
    }
    if (urlPatternInput && urlPatternInput.value) {
        params.set('urlPattern', urlPatternInput.value);
    } else {
        params.delete('urlPattern');
    }

    var newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    history.replaceState(null, '', newUrl);
}

function toDatetimeLocal(param) {
    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(param)) return param;
    var date = new Date(param);
    if (isNaN(date.getTime())) return null;
    var year = date.getFullYear();
    var month = String(date.getMonth() + 1).padStart(2, '0');
    var day = String(date.getDate()).padStart(2, '0');
    var hours = String(date.getHours()).padStart(2, '0');
    var minutes = String(date.getMinutes()).padStart(2, '0');
    return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
}

function loadDatesFromUrl() {
    var params = new URLSearchParams(window.location.search);
    var startInput = document.getElementById('startDate');
    var endInput = document.getElementById('endDate');
    var urlPatternInput = document.getElementById('urlPattern');

    var startParam = params.get('startDate');
    var endParam = params.get('endDate');
    var urlPatternParam = params.get('urlPattern');

    if (startParam && startInput) {
        var localValue = toDatetimeLocal(startParam);
        if (localValue) startInput.value = localValue;
    }
    if (endParam && endInput) {
        var localValue = toDatetimeLocal(endParam);
        if (localValue) endInput.value = localValue;
    }
    if (urlPatternParam !== null && urlPatternInput) {
        urlPatternInput.value = urlPatternParam;
    }
}

document.body.addEventListener('htmx:configRequest', function(evt) {
    var params = evt.detail.parameters;
    if (params.startDate) {
        var startDate = new Date(params.startDate);
        if (!isNaN(startDate.getTime())) params.startDate = startDate.toISOString();
    }
    if (params.endDate) {
        var endDate = new Date(params.endDate);
        if (!isNaN(endDate.getTime())) params.endDate = endDate.toISOString();
    }
    setTimeout(syncDatesToUrl, 0);
});

function validateDateRange() {
    var startInput = document.getElementById('startDate');
    var endInput = document.getElementById('endDate');
    var errorSpan = document.getElementById('dateError');

    if (startInput.value && endInput.value) {
        var start = new Date(startInput.value);
        var end = new Date(endInput.value);
        if (start >= end) {
            errorSpan.classList.remove('hidden');
            startInput.classList.add('border-red-500');
            endInput.classList.add('border-red-500');
        } else {
            errorSpan.classList.add('hidden');
            startInput.classList.remove('border-red-500');
            endInput.classList.remove('border-red-500');
        }
    }
}

function formatLocalTimes() {
    document.querySelectorAll('time[datetime]').forEach(function(el) {
        var date = new Date(el.getAttribute('datetime'));
        if (!isNaN(date.getTime())) {
            var month = date.toLocaleString('en-US', { month: 'short' });
            var day = date.getDate();
            var hours = String(date.getHours()).padStart(2, '0');
            var minutes = String(date.getMinutes()).padStart(2, '0');
            el.textContent = month + ' ' + day + ', ' + hours + ':' + minutes;
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    loadDatesFromUrl();
    validateDateRange();
    syncDatesToUrl();
    renderChart();
    formatLocalTimes();
});
</script>
{% endblock %}
